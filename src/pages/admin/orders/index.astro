---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { db } from '@/lib/db/connection';
import { orders, users } from '@/lib/db/schema';
import { eq, desc } from 'drizzle-orm';
import { Eye, Search, Filter, ChevronLeft, ChevronRight, Loader2 } from 'lucide-react';

const allOrders = await db.query.orders.findMany({
    with: {
        user: true,
        items: true
    },
    orderBy: [desc(orders.createdAt)]
});

// Adaptar datos para el resto del componente si es necesario
const mappedOrders = allOrders.map(o => ({
    ...o,
    customerName: o.user?.name,
    customerEmail: o.user?.email,
    date: o.createdAt
}));

// Calculate simple stats
const totalOrders = mappedOrders.length;
const pendingOrders = mappedOrders.filter(o => o.status === 'pending').length;
const totalRevenue = mappedOrders
    .filter(o => o.paymentStatus === 'approved')
    .reduce((sum, o) => sum + parseFloat(o.total), 0);

const statusColors = {
    pending: 'bg-amber-100 text-amber-800 border-amber-200',
    confirmed: 'bg-emerald-100 text-emerald-800 border-emerald-200',
    processing: 'bg-blue-100 text-blue-800 border-blue-200',
    shipped: 'bg-indigo-100 text-indigo-800 border-indigo-200',
    delivered: 'bg-emerald-100 text-emerald-800 border-emerald-200',
    cancelled: 'bg-rose-100 text-rose-800 border-rose-200',
};

const paymentStatusColors = {
    pending: 'bg-amber-50 text-amber-700 border-amber-100',
    approved: 'bg-emerald-50 text-emerald-700 border-emerald-100',
    rejected: 'bg-rose-50 text-rose-700 border-rose-100',
};

import { ShoppingBag, Clock, DollarSign, CheckCircle, Package, Truck, XCircle } from 'lucide-react';

const statusIcons = {
    pending: Clock,
    confirmed: CheckCircle,
    processing: Package,
    shipped: Truck,
    delivered: CheckCircle,
    cancelled: XCircle,
};
---

<AdminLayout title="Órdenes">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Gestión de Órdenes</h1>
        <p class="text-gray-500 mt-1">Monitorea y procesa todos los pedidos de la tienda.</p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center">
            <div class="p-3 bg-indigo-50 rounded-lg mr-4 text-indigo-600">
                <ShoppingBag className="w-6 h-6" />
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Pedidos</p>
                <p class="text-2xl font-bold text-gray-900">{totalOrders}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center">
            <div class="p-3 bg-amber-50 rounded-lg mr-4 text-amber-600">
                <Clock className="w-6 h-6" />
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Pendientes</p>
                <p class="text-2xl font-bold text-gray-900">{pendingOrders}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center">
            <div class="p-3 bg-emerald-50 rounded-lg mr-4 text-emerald-600">
                <DollarSign className="w-6 h-6" />
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Ingresos (Pagados)</p>
                <p class="text-2xl font-bold text-gray-900">${totalRevenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center">
        <div class="relative flex-1 w-full">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                <Search className="h-4 w-4" />
            </div>
            <input 
                type="text" 
                id="search-input"
                placeholder="Buscar por # pedido, nombre o email..." 
                class="pl-10 block w-full rounded-lg border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border transition-colors"
            />
        </div>
        <div class="flex gap-2 w-full md:w-auto">
            <select id="status-filter" class="block rounded-lg border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-3 bg-white">
                <option value="">Todos los estados</option>
                <option value="pending">Pendientes</option>
                <option value="processing">Procesando</option>
                <option value="shipped">Enviados</option>
                <option value="delivered">Entregados</option>
                <option value="cancelled">Cancelados</option>
            </select>
            <button class="inline-flex items-center px-4 py-2 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 h-11 whitespace-nowrap">
                <Filter className="w-4 h-4 mr-2" />
                Mas Filtros
            </button>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-100">
                <thead>
                    <tr class="bg-gray-50/50">
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Orden</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Cliente</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Total</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Pago</th>
                        <th class="relative px-6 py-4"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 bg-white" id="orders-table-body">
                    {mappedOrders.length === 0 ? (
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-gray-400">
                                    <ShoppingBag className="w-12 h-12 mb-3 opacity-20" />
                                    <p class="text-sm">No se encontraron órdenes registrados.</p>
                                </div>
                            </td>
                        </tr>
                    ) : (
                        mappedOrders.map((order) => {
                            const StatusIcon = statusIcons[order.status] || Clock;
                            return (
                                <tr class="hover:bg-gray-50/50 transition-colors group order-row" 
                                    data-status={order.status} 
                                    data-search={`${order.orderNumber} ${order.customerName || 'Administrador'} ${order.customerEmail || 'admin@decomoi.com'} ${order.items.map((i: any) => i.productName).join(' ')}`.toLowerCase()}
                                >
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded bg-gray-50 flex items-center justify-center border border-gray-100 group-hover:bg-white transition-colors mr-3">
                                                <span class="text-xs font-bold text-gray-400">#</span>
                                            </div>
                                            <span class="text-sm font-bold text-gray-900 group-hover:text-indigo-600 transition-colors">{order.orderNumber}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div class="font-medium text-gray-900">{order.customerName || 'Administrador'}</div>
                                        <div class="text-gray-500 text-xs">{order.customerEmail || 'admin@decomoi.com'}</div>
                                        <div class="mt-1 flex flex-wrap gap-1">
                                            {order.items.map((item: any) => (
                                                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-[10px] font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                                    {item.quantity}x {item.productName}
                                                </span>
                                            ))}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {new Date(order.date).toLocaleDateString()}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">
                                         ${parseFloat(order.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap" data-order-id={order.id} data-payment-status={order.paymentStatus}>
                                        {order.status === 'cancelled' ? (
                                            <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${statusColors[order.status]}`}>
                                                <XCircle className="w-3 h-3 mr-1.5" />
                                                Cancelado
                                            </span>
                                        ) : (
                                            <div class="relative inline-flex items-center group/status leading-none">
                                                <button 
                                                    type="button" 
                                                    class={`p-1 rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-colors focus:outline-none ${order.status === 'pending' ? 'invisible pointer-events-none' : ''} btn-status-prev`}
                                                    title="Retroceder estado"
                                                >
                                                    <ChevronLeft className="w-4 h-4" />
                                                </button>
                                                
                                                <span class={`mx-1 relative inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium border transition-colors duration-200 status-badge ${statusColors[order.status] || 'bg-gray-100 text-gray-800 border-gray-200'}`}>
                                                    <Clock className={`w-3 h-3 mr-1.5 status-icon-pending ${order.status !== 'pending' ? 'hidden' : ''}`} />
                                                    <CheckCircle className={`w-3 h-3 mr-1.5 status-icon-confirmed ${order.status !== 'confirmed' ? 'hidden' : ''}`} />
                                                    <Package className={`w-3 h-3 mr-1.5 status-icon-processing ${order.status !== 'processing' ? 'hidden' : ''}`} />
                                                    <Truck className={`w-3 h-3 mr-1.5 status-icon-shipped ${order.status !== 'shipped' ? 'hidden' : ''}`} />
                                                    <CheckCircle className={`w-3 h-3 mr-1.5 status-icon-delivered ${order.status !== 'delivered' ? 'hidden' : ''}`} />

                                                    <span class="status-label">
                                                        {order.status === 'confirmed' ? 'Confirmada' : 
                                                         order.status === 'processing' ? 'Procesando' : 
                                                         order.status === 'shipped' ? 'Enviado' : 
                                                         order.status === 'delivered' ? 'Entregado' : 
                                                         order.status === 'pending' ? 'Pendiente' : 
                                                         order.status}
                                                    </span>
                                                </span>

                                                <button 
                                                    type="button" 
                                                    class={`p-1 rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-colors focus:outline-none ${order.status === 'delivered' ? 'invisible pointer-events-none' : ''} btn-status-next`}
                                                    title="Avanzar estado"
                                                >
                                                    <ChevronRight className="w-4 h-4" />
                                                </button>

                                                <!-- Confirm box for backward navigation -->
                                                <div class="absolute left-1/2 -bottom-14 -translate-x-1/2 bg-white shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-gray-100 rounded-xl p-2 hidden z-20 flex-col items-center gap-2 min-w-[max-content] confirm-status-box">
                                                    <span class="text-[11px] font-bold text-gray-600 text-center whitespace-nowrap confirm-status-text uppercase tracking-wide">¿Retroceder a Pendiente?</span>
                                                    <div class="flex gap-2 w-full justify-center">
                                                        <button type="button" class="px-4 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition-colors confirm-status-yes">Sí</button>
                                                        <button type="button" class="px-4 py-1.5 bg-gray-50 text-gray-700 text-xs font-medium rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors confirm-status-no">No</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${paymentStatusColors[order.paymentStatus] || 'bg-gray-100 text-gray-800 border-gray-200'}`}>
                                            <div class={`w-1.5 h-1.5 rounded-full mr-1.5 ${order.paymentStatus === 'approved' ? 'bg-emerald-500' : order.paymentStatus === 'rejected' ? 'bg-rose-500' : 'bg-amber-500'}`}></div>
                                            {order.paymentStatus === 'approved' ? 'Pagado' : 
                                             order.paymentStatus === 'rejected' ? 'Fallido' : 
                                             order.paymentStatus === 'pending' ? 'Pendiente' : 
                                             order.paymentStatus}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a href={`/admin/orders/${order.id}`} class="inline-flex items-center px-3 py-1.5 border border-indigo-100 text-indigo-600 bg-indigo-50/50 hover:bg-indigo-600 hover:text-white rounded-lg transition-all">
                                            <Eye className="w-3.5 h-3.5 mr-1.5" />
                                            Ver
                                        </a>
                                    </td>
                                </tr>
                            );
                        })
                    )}
                </tbody>
            </table>
        </div>
    </div>

    <script is:inline>
        function initOrderList() {
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const rows = document.querySelectorAll('.order-row');

            function filterOrders() {
                const searchTerm = searchInput?.value.toLowerCase() || '';
                const statusTerm = statusFilter?.value || '';

                rows.forEach(row => {
                    const searchData = row.getAttribute('data-search') || '';
                    const statusData = row.getAttribute('data-status') || '';
                    
                    const matchesSearch = searchData.includes(searchTerm);
                    const matchesStatus = statusTerm === '' || statusData === statusTerm;

                    if (matchesSearch && matchesStatus) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            }

            if (searchInput && !searchInput.dataset.initialized) {
                searchInput.dataset.initialized = "true";
                searchInput.addEventListener('input', filterOrders);
            }
            if (statusFilter && !statusFilter.dataset.initialized) {
                statusFilter.dataset.initialized = "true";
                statusFilter.addEventListener('change', filterOrders);
            }

            // --- Inline Status Control Logic ---
            const statusFlow = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
            const statusTranslations = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmada',
                'processing': 'Procesando',
                'shipped': 'Enviado',
                'delivered': 'Entregado'
            };
            const statusColorsConfig = {
                'pending': 'bg-amber-100 text-amber-800 border-amber-200',
                'confirmed': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'processing': 'bg-blue-100 text-blue-800 border-blue-200',
                'shipped': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'delivered': 'bg-emerald-100 text-emerald-800 border-emerald-200'
            };

            const updateStatusUI = (row, newStatus) => {
                row.setAttribute('data-status', newStatus);
                const container = row.querySelector('.group\\/status');
                if (!container) return; // if it was cancelled

                const prevBtn = container.querySelector('.btn-status-prev');
                const nextBtn = container.querySelector('.btn-status-next');
                const badge = container.querySelector('.status-badge');
                const label = container.querySelector('.status-label');

                if (badge) {
                    Object.values(statusColorsConfig).forEach(cls => {
                        cls.split(' ').forEach(c => badge.classList.remove(c));
                    });
                    statusColorsConfig[newStatus].split(' ').forEach(c => badge.classList.add(c));
                }

                if (label) label.textContent = statusTranslations[newStatus];

                const icons = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
                icons.forEach(ic => {
                    const iconSvg = container.querySelector(`.status-icon-${ic}`);
                    if (iconSvg) {
                        if (ic === newStatus) iconSvg.classList.remove('hidden');
                        else iconSvg.classList.add('hidden');
                    }
                });

                const currentIndex = statusFlow.indexOf(newStatus);
                if (currentIndex <= 0) {
                    prevBtn?.classList.add('invisible', 'pointer-events-none');
                } else {
                    prevBtn?.classList.remove('invisible', 'pointer-events-none');
                }

                if (currentIndex >= statusFlow.length - 1) {
                    nextBtn?.classList.add('invisible', 'pointer-events-none');
                } else {
                    nextBtn?.classList.remove('invisible', 'pointer-events-none');
                }
                
                filterOrders(); // apply filters if it no longer matches the current selection
            };

            const changeStatus = async (row, orderId, newStatus, paymentStatus, spinnerBtnElement) => {
                const originalIconDisplay = spinnerBtnElement ? spinnerBtnElement.innerHTML : '';
                if (spinnerBtnElement) {
                    spinnerBtnElement.innerHTML = '<svg class="w-4 h-4 animate-spin text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                    spinnerBtnElement.disabled = true;
                }

                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus, paymentStatus: paymentStatus })
                    });

                    if (response.ok) {
                        updateStatusUI(row, newStatus);
                        if (window.showToast) window.showToast('Estado actualizado a ' + statusTranslations[newStatus]);
                    } else {
                        const err = await response.json();
                        if (window.showToast) window.showToast('Error: ' + err.error, 'error');
                    }
                } catch (err) {
                    if (window.showToast) window.showToast('Error de red', 'error');
                } finally {
                    if (spinnerBtnElement) {
                        spinnerBtnElement.innerHTML = originalIconDisplay;
                        spinnerBtnElement.disabled = false;
                    }
                }
            };

            rows.forEach(row => {
                if (row.dataset.eventsInitialized) return;
                row.dataset.eventsInitialized = "true";

                const nextBtn = row.querySelector('.btn-status-next');
                const prevBtn = row.querySelector('.btn-status-prev');
                const confirmBox = row.querySelector('.confirm-status-box');
                if (!nextBtn || !prevBtn || !confirmBox) return;

                const tdData = row.querySelector('td[data-order-id]');
                const orderId = tdData?.getAttribute('data-order-id');
                const paymentStatus = tdData?.getAttribute('data-payment-status');

                if (!orderId) return;

                nextBtn.addEventListener('click', () => {
                    const currentStatus = row.getAttribute('data-status');
                    const currentIndex = statusFlow.indexOf(currentStatus);
                    if (currentIndex >= 0 && currentIndex < statusFlow.length - 1) {
                        const nextStatus = statusFlow[currentIndex + 1];
                        changeStatus(row, orderId, nextStatus, paymentStatus, nextBtn);
                    }
                });

                prevBtn.addEventListener('click', (e) => {
                    const currentStatus = row.getAttribute('data-status');
                    const currentIndex = statusFlow.indexOf(currentStatus);
                    if (currentIndex > 0) {
                        const prevStatus = statusFlow[currentIndex - 1];
                        const confirmText = confirmBox.querySelector('.confirm-status-text');
                        if (confirmText) confirmText.textContent = `¿Retroceder a ${statusTranslations[prevStatus]}?`;
                        
                        document.querySelectorAll('.confirm-status-box').forEach(b => {
                            b.classList.add('hidden');
                            b.classList.remove('flex');
                        });

                        confirmBox.classList.remove('hidden');
                        confirmBox.classList.add('flex');

                        const btnYes = confirmBox.querySelector('.confirm-status-yes');
                        const btnNo = confirmBox.querySelector('.confirm-status-no');

                        if (btnYes && btnNo) {
                            const newBtnYes = btnYes.cloneNode(true);
                            const newBtnNo = btnNo.cloneNode(true);
                            btnYes.parentNode.replaceChild(newBtnYes, btnYes);
                            btnNo.parentNode.replaceChild(newBtnNo, btnNo);

                            newBtnYes.addEventListener('click', () => {
                                confirmBox.classList.add('hidden');
                                confirmBox.classList.remove('flex');
                                changeStatus(row, orderId, prevStatus, paymentStatus, prevBtn);
                            });
                            newBtnNo.addEventListener('click', () => {
                                confirmBox.classList.add('hidden');
                                confirmBox.classList.remove('flex');
                            });
                        }
                    }
                });
            });
        }

        initOrderList();
        
        if (!window.__orderEventsHooked) {
            window.__orderEventsHooked = true;
            document.addEventListener('astro:page-load', initOrderList);
            document.addEventListener('astro:after-swap', initOrderList);

            // Global watcher for clicking outside confirmation dialogs
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.group\\/status')) {
                    document.querySelectorAll('.confirm-status-box').forEach(b => {
                        b.classList.add('hidden');
                        b.classList.remove('flex');
                    });
                }
            });
        }
    </script>
</AdminLayout>
