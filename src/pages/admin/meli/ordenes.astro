---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../lib/db/connection';
import { meliOrders } from '../../../lib/db/schema';
import { desc } from 'drizzle-orm';

const ordersData = await db
  .select()
  .from(meliOrders)
  .orderBy(desc(meliOrders.dateCreated))
  .limit(50);
---

<AdminLayout title="Órdenes de MercadoLibre">
  <div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-9xl mx-auto">
    <div class="sm:flex sm:justify-between sm:items-center mb-8">
      <div class="mb-4 sm:mb-0">
        <h1 class="text-2xl md:text-3xl text-slate-800 dark:text-slate-100 font-bold">
          Órdenes MercadoLibre
        </h1>
      </div>
      <div class="flex gap-2">
         <button id="btnImport" class="btn bg-indigo-500 hover:bg-indigo-600 text-white">
            <svg class="w-4 h-4 fill-current opacity-50 shrink-0 mr-2" viewBox="0 0 16 16">
              <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z" />
            </svg>
            <span>Importar Recientes</span>
         </button>
         <a href="/admin/meli" class="btn bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600">Volver</a>
      </div>
    </div>

    <!-- Lista de Órdenes ML -->
    <div class="bg-white dark:bg-slate-800 shadow-lg rounded-sm border border-slate-200 dark:border-slate-700">
      <div class="overflow-x-auto">
        <table class="table-auto w-full dark:text-slate-300">
          <thead class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900 border-t border-b border-slate-200 dark:border-slate-700">
            <tr>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-left">N° Orden ML</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-left">Fecha</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-left">Comprador</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-left">Estado</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-right">Total</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-right">Comisión</div></th>
              <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap"><div class="font-semibold text-right">Neto</div></th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-slate-200 dark:divide-slate-700">
            {ordersData.length === 0 ? (
              <tr>
                 <td colspan="7" class="px-2 py-4 text-center text-slate-500">No se han importado órdenes desde MercadoLibre aún.</td>
              </tr>
            ) : null}
            {ordersData.map((ord) => (
              <tr>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                  <div class="font-medium text-slate-800 dark:text-slate-100">#{ord.meliOrderId}</div>
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                  {new Date(ord.dateCreated).toLocaleDateString('es-AR')}
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                  {ord.buyerNickname}
                  <div class="text-xs text-slate-400 max-w-40 truncate">{ord.buyerEmail}</div>
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                   <div class={`inline-flex font-medium rounded-full text-center px-2.5 py-0.5 ${
                     ord.status === 'paid' ? 'bg-emerald-100 text-emerald-600' :
                     ord.status === 'cancelled' ? 'bg-rose-100 text-rose-600' :
                     'bg-slate-100 text-slate-500'
                   }`}>{ord.status}</div>
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap text-right font-medium text-slate-800 dark:text-slate-100">
                  ${Number(ord.totalAmount).toLocaleString()}
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap text-right text-rose-500">
                  ${Number(ord.mlCommissionAmount).toLocaleString()}
                </td>
                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap text-right text-emerald-500 font-bold">
                  ${Number(ord.netAmount).toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</AdminLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnImport');
    if(btn) {
      btn.addEventListener('click', async () => {
        btn.innerText = 'Importando...';
        try {
          const res = await fetch('/api/meli/import-orders', { method: 'POST' });
          const json = await res.json();
          if(json.success) {
            alert(`Se procesaron ${json.data.imported} órdenes nuevas y hubieron ${json.data.errors} errores.`);
            window.location.reload();
          } else {
            alert('Error importando: ' + json.error);
            btn.innerText = 'Importar Recientes';
          }
        } catch(e) {
          alert('Error de red');
          btn.innerText = 'Importar Recientes';
        }
      });
    }
  });
</script>
