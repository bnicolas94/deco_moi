---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { Calendar, TrendingUp, TrendingDown, DollarSign, Package, Truck, ArrowRight, Activity, Percent, Calculator } from 'lucide-react';

// Default initial dates (This Month)
const now = new Date();
const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
---

<AdminLayout title="Panel de Rentabilidad">
    <div class="max-w-7xl mx-auto pb-20 space-y-8">
        <!-- Header & Filters -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight flex items-center gap-3">
                    <Activity className="w-8 h-8 text-indigo-600" />
                    Panel de Rentabilidad
                </h1>
                <p class="text-gray-500 mt-1 font-medium italic">Análisis financiero de ventas completadas y en proceso.</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 bg-gray-50 p-2 rounded-xl border border-gray-100">
                <select id="quick-date" class="rounded-lg border-gray-200 text-sm focus:ring-indigo-500 border h-10 px-3 bg-white shadow-sm font-medium">
                    <option value="today">Hoy</option>
                    <option value="week">Esta Semana</option>
                    <option value="month" selected>Este Mes</option>
                    <option value="year">Este Año</option>
                    <option value="custom">Personalizado</option>
                </select>
                
                <div id="custom-dates" class="hidden items-center gap-2">
                    <input type="date" id="date-start" value={firstDay} class="rounded-lg border-gray-200 text-sm focus:ring-indigo-500 h-10 px-3 border shadow-sm" />
                    <span class="text-gray-400"><ArrowRight className="w-4 h-4" /></span>
                    <input type="date" id="date-end" value={lastDay} class="rounded-lg border-gray-200 text-sm focus:ring-indigo-500 h-10 px-3 border shadow-sm" />
                </div>

                <div class="h-8 w-px bg-gray-200 mx-2"></div>

                <label class="flex items-center gap-2 cursor-pointer group">
                    <div class="relative">
                        <input type="checkbox" id="compare-toggle" class="sr-only peer" />
                        <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:width-4 after:transition-all peer-checked:bg-indigo-600"></div>
                    </div>
                    <span class="text-sm font-bold text-gray-700 group-hover:text-gray-900 transition-colors">Vs Mes Anterior</span>
                </label>

                <button id="refresh-btn" class="ml-2 p-2 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg transition-colors">
                    <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
        </div>

        <div id="loading" class="hidden justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>

        <div id="dashboard-content" class="space-y-8">
            <!-- Bloque 1: Resumen General -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110">
                        <DollarSign className="w-16 h-16 text-indigo-600" />
                    </div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Ingresos Brutos</h3>
                    <p class="text-2xl font-black text-gray-900" id="m-brutos">$0</p>
                    <p class="text-xs mt-2 text-gray-500 font-medium compare-stat hidden"><span class="text-emerald-500 flex items-center inline"><TrendingUp className="w-3 h-3 inline mr-1" /> 0%</span> vs mes ant.</p>
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110">
                        <Package className="w-16 h-16 text-rose-600" />
                    </div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Costos Configurables</h3>
                    <p class="text-2xl font-black text-rose-600" id="m-costos">$0</p>
                    <p class="text-xs mt-2 text-gray-500 font-medium compare-stat hidden"><span class="text-rose-500 flex items-center inline"><TrendingUp className="w-3 h-3 inline mr-1" /> 0%</span> vs mes ant.</p>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110">
                        <Truck className="w-16 h-16 text-amber-600" />
                    </div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Resultado Envíos</h3>
                    <p class="text-2xl font-black text-amber-600" id="m-envios">$0</p>
                    <p class="text-xs mt-2 text-gray-500 font-medium compare-stat hidden"><span class="text-gray-400 flex items-center inline">-</span> vs mes ant.</p>
                </div>

                <div class="bg-emerald-50 p-5 rounded-2xl shadow-sm border border-emerald-100 relative overflow-hidden group lg:col-span-2">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110">
                        <TrendingUp className="w-20 h-20 text-emerald-600" />
                    </div>
                    <h3 class="text-xs font-bold text-emerald-800 uppercase tracking-wider mb-1">Ingresos Netos</h3>
                    <div class="flex items-end gap-3">
                        <p class="text-3xl font-black text-emerald-700" id="m-netos">$0</p>
                        <p class="text-lg font-bold text-emerald-600 mb-1 bg-emerald-100 px-2 py-0.5 rounded-lg" id="m-margen">0% Margen</p>
                    </div>
                    <p class="text-xs mt-2 text-emerald-700/70 font-bold compare-stat hidden"><span class="text-emerald-600 flex items-center inline"><TrendingUp className="w-3 h-3 inline mr-1" /> 0%</span> netos vs mes ant.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Bloque 2: Desglose Costos -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-50">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <Calculator className="w-5 h-5 text-rose-500" /> Desglose de Costos
                        </h2>
                    </div>
                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">Ítem</th>
                                    <th class="p-4">Tipo</th>
                                    <th class="p-4 text-right">Impacto Total</th>
                                    <th class="p-4 text-right">% s/ Bruto</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="tb-costs">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bloque 3: Desglose Envíos -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-50">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <Truck className="w-5 h-5 text-amber-500" /> Desglose de Envíos
                        </h2>
                    </div>
                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">Zona</th>
                                    <th class="p-4 text-center">Órdenes</th>
                                    <th class="p-4 text-right">Cobrado</th>
                                    <th class="p-4 text-right">Costo Real</th>
                                    <th class="p-4 text-right">Diferencia</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="tb-shipping">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bloque 4: Rentabilidad por Producto -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-5 border-b border-gray-50">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <Package className="w-5 h-5 text-indigo-500" /> Rentabilidad por Producto
                    </h2>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">
                            <tr>
                                <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 0)">Producto ↕</th>
                                <th class="p-4 text-center cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 1, true)">Unidades ↕</th>
                                <th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 2, true)">Ingreso Bruto ↕</th>
                                <th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 3, true)">Costo Total ↕</th>
                                <th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 4, true)">Gcia. Neta ↕</th>
                                <th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('tb-products', 5, true)">Margen % ↕</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="tb-products">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Bloque 5: Comparativa se mostrará on-demand a través de UI elements hidden by default que activaremos si compare=true -->
            <!-- En este MVP manejaremos la comparativa directamente inyectando los % de delta en las cards del Bloque 1 -->
        </div>

    </div>
</AdminLayout>

<script is:inline>
    const qs = document.querySelector.bind(document);
    const qsa = document.querySelectorAll.bind(document);

    const fmtMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
    const fmtPct = (val) => Number(val).toFixed(1) + '%';

    // UI Elements
    const dateSelect = qs('#quick-date');
    const customDates = qs('#custom-dates');
    const startInput = qs('#date-start');
    const endInput = qs('#date-end');
    const compareToggle = qs('#compare-toggle');
    const btnRefresh = qs('#refresh-btn');
    const loading = qs('#loading');
    const content = qs('#dashboard-content');

    // Filter Logic
    function getDates() {
        const val = dateSelect.value;
        const now = new Date();
        let start, end;

        if (val === 'today') {
            start = end = now.toISOString().split('T')[0];
        } else if (val === 'week') {
            const first = now.getDate() - now.getDay();
            start = new Date(now.setDate(first)).toISOString().split('T')[0];
            end = new Date(now.setDate(first + 6)).toISOString().split('T')[0];
        } else if (val === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        } else if (val === 'year') {
            start = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
            end = new Date(now.getFullYear(), 11, 31).toISOString().split('T')[0];
        } else {
            start = startInput.value;
            end = endInput.value;
        }
        return { start, end };
    }

    dateSelect.addEventListener('change', () => {
        if (dateSelect.value === 'custom') {
            customDates.classList.remove('hidden');
            customDates.classList.add('flex');
        } else {
            customDates.classList.add('hidden');
            customDates.classList.remove('flex');
            fetchDashboard();
        }
    });

    [startInput, endInput, compareToggle, btnRefresh].forEach(el => {
        el.addEventListener('change', fetchDashboard);
        if (el.tagName === 'BUTTON') el.addEventListener('click', fetchDashboard);
    });

    async function fetchDashboard() {
        const { start, end } = getDates();
        loading.classList.remove('hidden');
        content.classList.add('opacity-50', 'pointer-events-none');
        btnRefresh.querySelector('svg').classList.add('animate-spin');

        try {
            // Main fetch
            const res = await fetch(`/api/costs/dashboard-stats?start=${start}&end=${end}`);
            const data = await res.json();
            
            let compareData = null;
            if (compareToggle.checked) {
                // Calculate previous period
                const sDate = new Date(start);
                const eDate = new Date(end);
                const diffTime = Math.abs(eDate - sDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                sDate.setDate(sDate.getDate() - diffDays - 1);
                eDate.setDate(eDate.getDate() - diffDays - 1);
                
                const pStart = sDate.toISOString().split('T')[0];
                const pEnd = eDate.toISOString().split('T')[0];
                
                const resCmp = await fetch(`/api/costs/dashboard-stats?start=${pStart}&end=${pEnd}`);
                compareData = await resCmp.json();
            }

            renderDashboard(data, compareData);
        } catch (e) {
            console.error("Dashboard error:", e);
        } finally {
            loading.classList.add('hidden');
            content.classList.remove('opacity-50', 'pointer-events-none');
            btnRefresh.querySelector('svg').classList.remove('animate-spin');
        }
    }

    function renderDelta(current, prev, isInverseGood = false) {
        if (!prev || prev === 0) return `<span class="text-gray-400">-</span>`;
        const delta = ((current - prev) / prev) * 100;
        const isUp = delta > 0;
        let isGood = isUp;
        if (isInverseGood) isGood = !isUp; // e.g costs going down is good
        
        let color = isGood ? 'text-emerald-500' : 'text-rose-500';
        let icon = isUp ? '<path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/>' : '<path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/>';
        
        return `<span class="${color} flex items-center inline"><svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">${icon}</svg> ${Math.abs(delta).toFixed(1)}%</span>`;
    }

    function renderDashboard(data, compareData) {
        // Bloque 1: Cards
        qs('#m-brutos').textContent = fmtMoney(data.summary.ingresosBrutos);
        qs('#m-costos').textContent = fmtMoney(data.summary.costosConfigurables);
        
        const resEnv = data.summary.resultadoEnvios;
        qs('#m-envios').textContent = fmtMoney(resEnv);
        qs('#m-envios').className = `text-2xl font-black ${resEnv >= 0 ? 'text-emerald-600' : 'text-rose-600'}`;
        
        qs('#m-netos').textContent = fmtMoney(data.summary.ingresosNetos);
        qs('#m-margen').textContent = `${fmtPct(data.summary.margenPorcentaje)} M.N`;

        const compareLabels = qsa('.compare-stat');
        if (compareData) {
            compareLabels.forEach(el => el.classList.remove('hidden'));
            compareLabels[0].innerHTML = `${renderDelta(data.summary.ingresosBrutos, compareData.summary.ingresosBrutos)} vs per. ant.`;
            compareLabels[1].innerHTML = `${renderDelta(data.summary.costosConfigurables, compareData.summary.costosConfigurables, true)} vs per. ant.`;
            compareLabels[2].innerHTML = ``; // envios (demasiado variable, o lo skipeamos)
            compareLabels[3].innerHTML = `${renderDelta(data.summary.ingresosNetos, compareData.summary.ingresosNetos)} vs per. ant.`;
        } else {
            compareLabels.forEach(el => el.classList.add('hidden'));
        }

        // Bloque 2: Costos
        const tbCost = qs('#tb-costs');
        tbCost.innerHTML = '';
        if (data.breakdownCosts.length === 0) tbCost.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Sin costos configurables procesados en este período.</td></tr>';
        
        data.breakdownCosts.forEach(c => {
            const pct = data.summary.ingresosBrutos > 0 ? (c.totalAmount / data.summary.ingresosBrutos) * 100 : 0;
            tbCost.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-bold text-gray-900">${c.name}</td>
                    <td class="p-4 text-xs font-medium text-gray-500 uppercase">${c.type === 'percentage' ? c.value + '%' : 'Fijo'}</td>
                    <td class="p-4 text-right text-rose-600 font-bold">${fmtMoney(c.totalAmount)}</td>
                    <td class="p-4 text-right text-gray-700">${fmtPct(pct)}</td>
                </tr>
            `;
        });

        // Bloque 3: Envíos
        const tbShip = qs('#tb-shipping');
        tbShip.innerHTML = '';
        if (data.breakdownShipping.length === 0) tbShip.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Sin envíos en este período.</td></tr>';
        
        data.breakdownShipping.forEach(s => {
            const diff = s.cobrado - s.costoReal;
            const diffColor = diff > 0 ? 'text-emerald-600 bg-emerald-50' : (diff < 0 ? 'text-rose-600 bg-rose-50' : 'text-gray-600 bg-gray-50');
            tbShip.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-bold text-gray-900">${s.zone}</td>
                    <td class="p-4 text-center text-gray-500">${s.ord}</td>
                    <td class="p-4 text-right font-medium text-gray-700">${fmtMoney(s.cobrado)}</td>
                    <td class="p-4 text-right font-medium text-gray-500">${fmtMoney(s.costoReal)}</td>
                    <td class="p-4 text-right">
                        <span class="px-2 py-1 rounded inline-block font-bold text-xs ${diffColor}">
                            ${diff > 0 ? '+' : ''}${fmtMoney(diff)}
                        </span>
                    </td>
                </tr>
            `;
        });

        // Bloque 4: Productos
        const tbProd = qs('#tb-products');
        tbProd.innerHTML = '';
        if (data.breakdownProducts.length === 0) tbProd.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Sin productos vendidos.</td></tr>';
        
        data.breakdownProducts.forEach(p => {
            const neta = p.ingresos - p.costos;
            const pct = p.ingresos > 0 ? (neta / p.ingresos) * 100 : 0;
            const isLoss = neta < 0;
            const warning = p.costos === 0 ? `<br><span class="text-[10px] bg-amber-100 text-amber-700 px-1 py-0.5 rounded">Sin costos configurados</span>` : '';
            
            tbProd.innerHTML += `
                <tr class="hover:bg-gray-50 product-row" data-[0]="${p.name.toLowerCase()}" data-[1]="${p.units}" data-[2]="${p.ingresos}" data-[3]="${p.costos}" data-[4]="${neta}" data-[5]="${pct}">
                    <td class="p-4 font-bold text-gray-900">${p.name} ${warning}</td>
                    <td class="p-4 text-center text-gray-700">${p.units}</td>
                    <td class="p-4 text-right font-medium text-indigo-900">${fmtMoney(p.ingresos)}</td>
                    <td class="p-4 text-right font-medium text-rose-600">${fmtMoney(p.costos)}</td>
                    <td class="p-4 text-right font-black ${isLoss ? 'text-rose-600' : 'text-emerald-600'}">${fmtMoney(neta)}</td>
                    <td class="p-4 text-right font-bold text-gray-600">${fmtPct(pct)}</td>
                </tr>
            `;
        });
    }

    // Sort util
    let currentSort = -1;
    let sortAsc = false;
    function sortTable(tableId, colIdx, isNumeric = false) {
        const tbody = document.getElementById(tableId);
        const rows = Array.from(tbody.querySelectorAll('tr.product-row'));
        if (rows.length === 0) return;

        sortAsc = currentSort === colIdx ? !sortAsc : false;
        currentSort = colIdx;

        rows.sort((a, b) => {
            const vA = a.getAttribute(`data-[${colIdx}]`);
            const vB = b.getAttribute(`data-[${colIdx}]`);
            if (isNumeric) {
                return sortAsc ? parseFloat(vA) - parseFloat(vB) : parseFloat(vB) - parseFloat(vA);
            } else {
                return sortAsc ? vA.localeCompare(vB) : vB.localeCompare(vA);
            }
        });

        rows.forEach(r => tbody.appendChild(r));
    }

    // Init
    fetchDashboard();
</script>
