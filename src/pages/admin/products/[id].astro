---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { db } from '@/lib/db/connection';
import { products, categories, mockupTemplates, productionTimeRules } from '@/lib/db/schema';
import { eq, asc } from 'drizzle-orm';
import { Save, ArrowLeft, Image as ImageIcon, Trash2, Star, Plus, Clock } from 'lucide-react';

const { id } = Astro.params;
const isNew = id === 'new';

// Fetch initial data
let product = null;
let variants = [];
let timeRules = [];
if (!isNew && id) {
    const result = await db.query.products.findFirst({
        where: eq(products.id, parseInt(id)),
        with: {
            variants: true
        }
    });
    product = result;
    variants = result?.variants || [];
    
    if (!product) {
        return Astro.redirect('/admin/products');
    }

    // Load production time rules
    timeRules = await db.select().from(productionTimeRules)
        .where(eq(productionTimeRules.productId, parseInt(id)))
        .orderBy(asc(productionTimeRules.minQuantity));
}

const allCategories = await db.select().from(categories).orderBy(categories.name);
const allTemplates = await db.select().from(mockupTemplates).orderBy(mockupTemplates.name);

// Process images to identify cover (first one)
const currentImages = product?.images || [];
---

<AdminLayout title={isNew ? "Nuevo Producto" : `Editar: ${product.name}`}>
    <form id="product-form" class="max-w-7xl mx-auto pb-20">
        <!-- Header -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-4">
                <a 
                    href="/admin/products" 
                    class="p-2.5 bg-white border border-gray-100 text-gray-400 hover:text-gray-600 rounded-xl transition-all shadow-sm active:scale-95"
                >
                    <ArrowLeft className="w-5 h-5" />
                </a>
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                        {isNew ? "Nuevo Producto" : "Editar Producto"}
                    </h1>
                    <p class="text-gray-500 mt-1 font-medium italic">
                        {isNew ? "Añade un nuevo ítem a tu catálogo." : `Gestionando "${product.name}"`}
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                {!isNew && (
                    <button 
                        type="button" 
                        onclick={`if(confirm('¿Seguro?')) fetch('/api/products/${id}', {method:'DELETE'}).then(()=>location.href='/admin/products')`}
                        class="flex-1 md:flex-none inline-flex items-center justify-center px-5 py-2.5 border-2 border-rose-50 text-rose-500 hover:bg-rose-50 font-bold rounded-xl transition-all"
                    >
                        <Trash2 className="w-5 h-5 mr-2" />
                        Eliminar
                    </button>
                )}
                <button 
                    type="submit" 
                    form="product-form"
                    class="flex-1 md:flex-none inline-flex items-center justify-center px-8 py-2.5 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg shadow-gray-200 transition-all transform active:scale-95"
                >
                    <Save className="w-5 h-5 mr-2" />
                    Guardar Cambios
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-8">
                <!-- 1. General Information -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2.5">
                            <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                            Información General
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">Nombre del Producto</label>
                                <input 
                                    type="text" 
                                    name="name" 
                                    id="name"
                                    value={product?.name} 
                                    required 
                                    placeholder="Ej: Vela Aromática de Lavanda"
                                    class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4 transition-all"
                                />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">Slug (URL)</label>
                                <input 
                                    type="text" 
                                    name="slug" 
                                    id="slug"
                                    value={product?.slug} 
                                    required 
                                    placeholder="vela-aromatica-lavanda"
                                    class="block w-full rounded-xl border-gray-200 bg-gray-50 text-gray-500 sm:text-sm h-11 border px-4"
                                />
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Descripción Corta</label>
                            <input 
                                type="text" 
                                name="shortDescription" 
                                value={product?.shortDescription} 
                                placeholder="Breve resumen para el catálogo..."
                                class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4 transition-all"
                            />
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700">Descripción Detallada</label>
                            <textarea 
                                name="description" 
                                rows="5" 
                                class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-4 transition-all"
                                placeholder="Escribe las características, beneficios y detalles del producto..."
                            >{product?.description}</textarea>
                        </div>
                    </div>
                </div>

                <!-- 2. Pricing & Logistics -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2.5">
                            <span class="w-2 h-6 bg-emerald-500 rounded-full"></span>
                            Precios y Logística
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2 group">
                                <label class="block text-sm font-bold text-gray-700 group-focus-within:text-indigo-600 transition-colors">Precio Base</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3.5 flex items-center text-gray-400 font-bold">$</span>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        name="basePrice" 
                                        value={product?.basePrice} 
                                        required 
                                        class="block w-full pl-8 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border transition-all"
                                    />
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">Inventario Inicial</label>
                                <input 
                                    type="number" 
                                    name="stock" 
                                    value={product?.stock} 
                                    required 
                                    class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4 transition-all"
                                />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">SKU</label>
                                <input 
                                    type="text" 
                                    name="sku" 
                                    value={product?.sku} 
                                    placeholder="PRD-001"
                                    class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4"
                                />
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-50">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">Tiempo de Producción (fallback)</label>
                                <input 
                                    type="text" 
                                    name="productionTime" 
                                    value={product?.productionTime} 
                                    placeholder="Ej: 3-5 días hábiles (se usa si no hay rangos)"
                                    class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4"
                                />
                                <p class="text-[10px] text-gray-400 italic">Se muestra si la cantidad no cae en ningún rango configurado abajo.</p>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700">Pedido Mínimo</label>
                                <input 
                                    type="number" 
                                    name="minOrder" 
                                    value={product?.minOrder || 1} 
                                    class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-4 transition-all"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2b. Production Time Rules -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50 flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2.5">
                            <span class="w-2 h-6 bg-amber-500 rounded-full"></span>
                            Tiempos de Producción por Cantidad
                        </h2>
                        <button 
                            type="button" 
                            id="add-time-rule-btn"
                            class="inline-flex items-center px-3 py-1.5 bg-amber-50 text-amber-600 text-xs font-bold rounded-lg hover:bg-amber-100 transition-colors border border-amber-100"
                        >
                            <Plus className="w-3.5 h-3.5 mr-1" />
                            Agregar Rango
                        </button>
                    </div>

                    <div class="p-6">
                        <p class="text-xs text-gray-500 mb-6 bg-gray-50 p-3 rounded-xl border border-gray-100 italic">
                            Define tiempos de producción según la cantidad del pedido. Si el usuario introduce una cantidad que no cae en ningún rango, se muestra el valor de fallback.
                        </p>

                        <div id="time-rules-container" class="space-y-4">
                            {timeRules.length === 0 ? (
                                <div id="no-time-rules-msg" class="text-center py-8 border-2 border-dashed border-gray-100 rounded-2xl">
                                    <p class="text-sm text-gray-400">No hay rangos definidos. Se usará el tiempo de producción de fallback.</p>
                                </div>
                            ) : (
                                timeRules.map((rule, idx) => (
                                    <div class="time-rule-item grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-amber-50/30 rounded-2xl border border-amber-100/50 relative group animate-in fade-in slide-in-from-top-2">
                                        <div class="md:col-span-3">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cantidad Mínima</label>
                                            <input type="number" name={`time_rule_min_${idx}`} value={rule.minQuantity} min="1" placeholder="1" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" required />
                                        </div>
                                        <div class="md:col-span-3">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cantidad Máxima</label>
                                            <input type="number" name={`time_rule_max_${idx}`} value={rule.maxQuantity} placeholder="Sin límite" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" />
                                        </div>
                                        <div class="md:col-span-5">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tiempo de Producción</label>
                                            <input type="text" name={`time_rule_time_${idx}`} value={rule.productionTime} placeholder="Ej: 5-7 días hábiles" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" required />
                                        </div>
                                        <div class="md:col-span-1 flex items-end justify-center pb-1">
                                            <button type="button" class="remove-time-rule-btn p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>

                <!-- 3. Product Variants -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50 flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm9 4a1 1 0 10-2 0v2H8V7a1 1 0 00-2 0v2H4.5a.5.5 0 000 1H6v2H4.5a.5.5 0 000 1H6v2a1 1 0 102 0v-2h4v2a1 1 0 102 0v-2h1.5a.5.5 0 000-1H14v-2h1.5a.5.5 0 000-1H14V7z" clip-rule="evenodd" />
                            </svg>
                            Variantes de Producto
                        </h2>
                        <button 
                            type="button" 
                            id="add-variant-btn"
                            class="inline-flex items-center px-3 py-1.5 bg-indigo-50 text-indigo-600 text-xs font-bold rounded-lg hover:bg-indigo-100 transition-colors border border-indigo-100"
                        >
                            <Plus className="w-3.5 h-3.5 mr-1" />
                            Añadir Variante
                        </button>
                    </div>

                    <div class="p-6">
                        <p class="text-xs text-gray-500 mb-6 bg-gray-50 p-3 rounded-xl border border-gray-100 italic">
                            Usa las variantes para productos con diferentes tallas, colores o materiales. Cada variante puede tener su propio SKU y stock.
                        </p>

                        <div id="variants-container" class="space-y-4">
                            {variants.length === 0 ? (
                                <div id="no-variants-msg" class="text-center py-8 border-2 border-dashed border-gray-100 rounded-2xl">
                                    <p class="text-sm text-gray-400">No hay variantes definidas. El producto se tratará como unidad única.</p>
                                </div>
                            ) : (
                                variants.map((v, idx) => (
                                    <div class="variant-item grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50/50 rounded-2xl border border-gray-100 relative group animate-in fade-in slide-in-from-top-2">
                                        <input type="hidden" name={`variant_id_${idx}`} value={v.id} />
                                        <input type="hidden" name={`variant_existing_image_${idx}`} value={v.image || ''} />
                                        <div class="md:col-span-3">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nombre / Atributos</label>
                                            <input type="text" name={`variant_name_${idx}`} value={v.name} placeholder="Ej: Rojo / XL" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" required />
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">SKU</label>
                                            <input type="text" name={`variant_sku_${idx}`} value={v.sku} placeholder="SKU Único" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" />
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Precio Opc.</label>
                                            <input type="number" step="0.01" name={`variant_price_${idx}`} value={v.price} placeholder="Base" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" />
                                        </div>
                                        <div class="md:col-span-1">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Stock</label>
                                            <input type="number" name={`variant_stock_${idx}`} value={v.stock} class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" required />
                                        </div>
                                        <div class="md:col-span-3">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Opc.</label>
                                            <div class="flex items-center gap-2">
                                                {v.image ? (
                                                    <img src={v.image} class="w-10 h-10 object-cover rounded-lg border border-gray-200" alt={v.name} />
                                                ) : (
                                                    <div class="w-10 h-10 rounded-lg border-2 border-dashed border-gray-200 flex items-center justify-center">
                                                        <ImageIcon className="w-4 h-4 text-gray-300" />
                                                    </div>
                                                )}
                                                <label class="flex-1 cursor-pointer">
                                                    <span class="text-[10px] text-indigo-500 font-bold hover:text-indigo-700 transition-colors">{v.image ? 'Cambiar' : 'Subir'}</span>
                                                    <input type="file" accept="image/*" name={`variant_image_${idx}`} class="hidden variant-image-input" />
                                                </label>
                                            </div>
                                        </div>
                                        <div class="md:col-span-1 flex items-end justify-center pb-1">
                                            <button type="button" class="remove-variant-btn p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-8">
                <!-- Status & Template -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-6">
                    <div class="space-y-4">
                        <label class="flex items-center group cursor-pointer">
                            <div class="relative flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="isActive"
                                    name="isActive" 
                                    checked={isNew ? true : product.isActive} 
                                    value="true"
                                    class="sr-only peer"
                                />
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:width-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                <span class="ml-3 text-sm font-bold text-gray-700 group-hover:text-gray-900 transition-colors">Producto Activo</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center group cursor-pointer">
                            <div class="relative flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="isFeatured"
                                    name="isFeatured" 
                                    checked={product?.isFeatured} 
                                    value="true"
                                    class="sr-only peer"
                                />
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:width-5 after:transition-all peer-checked:bg-amber-400"></div>
                                <span class="ml-3 text-sm font-bold text-gray-700 group-hover:text-gray-900 transition-colors flex items-center gap-1.5 focus:ring-amber-500">
                                    <Star className={`w-4 h-4 ${product?.isFeatured ? 'fill-amber-400 text-amber-400' : 'text-gray-400'}`} />
                                    Destacado
                                </span>
                            </div>
                        </label>
                    </div>

                    <div class="space-y-2 pt-4 border-t border-gray-50">
                        <label class="block text-sm font-bold text-gray-700">Categoría</label>
                        <select 
                            name="categoryId" 
                            required
                            class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-3 bg-white transition-all"
                        >
                            <option value="">Seleccionar categoría...</option>
                            {allCategories.map(cat => (
                                <option value={cat.id} selected={product?.categoryId === cat.id}>{cat.name}</option>
                            ))}
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">Plantilla Mockup</label>
                        <select 
                            name="mockupTemplateId" 
                            class="block w-full rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-11 border px-3 bg-white transition-all"
                        >
                            <option value="">Sin plantilla</option>
                            {allTemplates.map(template => (
                                <option value={template.id} selected={product?.mockupTemplateId === template.id}>
                                    {template.name}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>

                <!-- Images Management -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-bold text-gray-900 flex items-center gap-2">
                            <ImageIcon className="w-4 h-4 text-indigo-500" />
                            Imágenes del Producto
                        </h3>
                    </div>

                    {/* Drag & Drop Hint */}
                    <p class="text-[10px] text-gray-400 bg-gray-50 p-2 rounded-lg border border-gray-100 flex items-center gap-1.5 line-height-tight">
                         Arrastra para reordenar. La primera imagen será la de portada.
                    </p>

                    <div id="existing-images" class="grid grid-cols-2 gap-3 min-h-[100px]">
                        {currentImages.map((img, idx) => (
                            <div 
                                id={`img-${idx}`}
                                class="existing-image-item relative group rounded-xl overflow-hidden border border-gray-100 shadow-sm cursor-move transition-all active:scale-95 active:rotate-2 hover:shadow-md h-24"
                                draggable="true"
                            >
                                <input type="hidden" name="existingImages" value={img} />
                                <img src={img} class="w-full h-full object-cover transition-transform group-hover:scale-110" />
                                
                                {/* Image Overlay/Actions */}
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                    <button 
                                        type="button" 
                                        class="set-cover-btn p-1.5 bg-white/20 hover:bg-white/40 text-white rounded-lg transition-colors"
                                        title="Hacer portada"
                                    >
                                        <Star className="w-3.5 h-3.5 fill-current" />
                                    </button>
                                    <button 
                                        type="button" 
                                        class="remove-image-btn p-1.5 bg-white/20 hover:bg-rose-500 text-white rounded-lg transition-colors"
                                        title="Eliminar"
                                        data-image-id={`img-${idx}`}
                                        data-is-new="false"
                                    >
                                        <Plus className="w-3.5 h-3.5 rotate-45" />
                                    </button>
                                </div>

                                {/* Cover Badge */}
                                <div class="cover-badge absolute top-1.5 left-1.5 bg-indigo-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg uppercase tracking-wider opacity-0 pointer-events-none transition-opacity">
                                    Portada
                                </div>
                            </div>
                        ))}
                    </div>

                    <label class="relative flex flex-col items-center justify-center py-8 border-2 border-dashed border-gray-200 rounded-2xl cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/30 transition-all group">
                        <div class="flex flex-col items-center justify-center space-y-2">
                            <div class="p-2.5 bg-gray-50 border border-gray-100 rounded-xl group-hover:bg-indigo-50 transition-colors">
                                <Plus className="w-5 h-5 text-gray-400 group-hover:text-indigo-500" />
                            </div>
                        </div>
                        <input 
                            type="file" 
                            name="image" 
                            id="image" 
                            multiple
                            class="hidden" 
                        />
                    </label>

                    <!-- New Images Preview -->
                    <div id="new-images-container" class="grid grid-cols-2 gap-2 mt-4 hidden"></div>
                </div>
            </div>
        </div>
    </form>
</AdminLayout>

<script is:inline define:vars={{ isNew, id: product?.id }}>
    // Auto-generate slug from name
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    
    nameInput?.addEventListener('input', (e) => {
        if (isNew || !slugInput.value) {
            const slug = e.target.value
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove accents
                .replace(/[^a-z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-');
            slugInput.value = slug;
        }
    });

    // Event Listeners Setup
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('product-form');
        if (form) {
            form.addEventListener('submit', handleSubmit);
        }

        // Delegate remove image events
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-image-btn');
            if (btn) {
                const imageId = btn.getAttribute('data-image-id');
                const isNew = btn.getAttribute('data-is-new') === 'true';
                
                if (isNew) {
                    removeNewImage(imageId);
                } else {
                    removeExistingImage(imageId);
                }
            }
        });

        // Image Upload Preview
        const imageInput = document.getElementById('image');
        const newImagesContainer = document.getElementById('new-images-container');
        const dt = new DataTransfer();

        imageInput?.addEventListener('change', (e) => {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                dt.items.add(file);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = () => {
                    const uniqueId = 'new-img-' + Date.now() + '-' + i;
                    const div = document.createElement('div');
                    div.className = 'relative group';
                    div.id = uniqueId;
                    div.innerHTML = `
                        <img src="${reader.result}" class="w-full h-24 object-cover rounded shadow-sm opacity-75 border-2 border-indigo-200" />
                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 remove-image-btn shadow-md" data-image-id="${uniqueId}" data-is-new="true">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>`;
                    newImagesContainer.appendChild(div);
                }
            }
            imageInput.files = dt.files;
            if (dt.files.length > 0) newImagesContainer.classList.remove('hidden');
        });

        // DnD and Cover Logic
        const container = document.getElementById('existing-images');
        if (container) {
            updateCoverBadge();
            let draggedItem = null;

            container.addEventListener('dragstart', (e) => {
                draggedItem = e.target.closest('.existing-image-item');
                e.dataTransfer.effectAllowed = 'move';
                draggedItem.style.opacity = '0.5';
            });

            container.addEventListener('dragend', (e) => {
                if (draggedItem) draggedItem.style.opacity = '1';
                draggedItem = null;
                updateCoverBadge();
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY, e.clientX);
                if (draggedItem) {
                    if (afterElement == null) {
                        container.appendChild(draggedItem);
                    } else {
                        container.insertBefore(draggedItem, afterElement);
                    }
                }
            });

            container.addEventListener('click', (e) => {
                const btn = e.target.closest('.set-cover-btn');
                if (btn) {
                    const item = btn.closest('.existing-image-item');
                    container.prepend(item);
                    updateCoverBadge();
                }
            });
        }

        // Variants Logic
        const addVariantBtn = document.getElementById('add-variant-btn');
        const variantsContainer = document.getElementById('variants-container');
        const noVariantsMsg = document.getElementById('no-variants-msg');
        let variantCount = document.querySelectorAll('.variant-item').length;

        addVariantBtn?.addEventListener('click', () => {
            if (noVariantsMsg) noVariantsMsg.remove();
            const variantIdx = variantCount++;
            const div = document.createElement('div');
            div.className = 'variant-item grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50/50 rounded-2xl border border-gray-100 relative group animate-in fade-in slide-in-from-top-2';
            div.innerHTML = `
                <input type="hidden" name="variant_existing_image_${variantIdx}" value="" />
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nombre / Atributos</label>
                    <input type="text" name="variant_name_${variantIdx}" placeholder="Ej: Rojo / XL" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" required />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">SKU</label>
                    <input type="text" name="variant_sku_${variantIdx}" placeholder="SKU Único" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Precio Opc.</label>
                    <input type="number" step="0.01" name="variant_price_${variantIdx}" placeholder="Base" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" />
                </div>
                <div class="md:col-span-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Stock</label>
                    <input type="number" name="variant_stock_${variantIdx}" value="0" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-indigo-500" required />
                </div>
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Opc.</label>
                    <div class="flex items-center gap-2">
                        <div class="variant-img-preview w-10 h-10 rounded-lg border-2 border-dashed border-gray-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        </div>
                        <label class="flex-1 cursor-pointer">
                            <span class="text-[10px] text-indigo-500 font-bold hover:text-indigo-700 transition-colors">Subir</span>
                            <input type="file" accept="image/*" name="variant_image_${variantIdx}" class="hidden variant-image-input" />
                        </label>
                    </div>
                </div>
                <div class="md:col-span-1 flex items-end justify-center pb-1">
                    <button type="button" class="remove-variant-btn p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>`;
            variantsContainer.appendChild(div);
            // Attach image preview listener
            attachVariantImagePreview(div.querySelector('.variant-image-input'));
        });

        variantsContainer?.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-variant-btn');
            if (btn) {
                btn.closest('.variant-item').remove();
                if (document.querySelectorAll('.variant-item').length === 0) {
                    variantsContainer.innerHTML = `<div id="no-variants-msg" class="text-center py-8 border-2 border-dashed border-gray-100 rounded-2xl"><p class="text-sm text-gray-400">No hay variantes definidas. El producto se tratará como unidad única.</p></div>`;
                }
            }
        });

        // Variant image preview for existing inputs
        document.querySelectorAll('.variant-image-input').forEach(input => {
            attachVariantImagePreview(input);
        });

        // ========================================
        // Production Time Rules Logic
        // ========================================
        const addTimeRuleBtn = document.getElementById('add-time-rule-btn');
        const timeRulesContainer = document.getElementById('time-rules-container');
        const noTimeRulesMsg = document.getElementById('no-time-rules-msg');
        let timeRuleCount = document.querySelectorAll('.time-rule-item').length;

        addTimeRuleBtn?.addEventListener('click', () => {
            if (noTimeRulesMsg) noTimeRulesMsg.remove();
            const ruleIdx = timeRuleCount++;
            const div = document.createElement('div');
            div.className = 'time-rule-item grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-amber-50/30 rounded-2xl border border-amber-100/50 relative group animate-in fade-in slide-in-from-top-2';
            div.innerHTML = `
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cantidad Mínima</label>
                    <input type="number" name="time_rule_min_${ruleIdx}" min="1" placeholder="1" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" required />
                </div>
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cantidad Máxima</label>
                    <input type="number" name="time_rule_max_${ruleIdx}" placeholder="Sin límite" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" />
                </div>
                <div class="md:col-span-5">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tiempo de Producción</label>
                    <input type="text" name="time_rule_time_${ruleIdx}" placeholder="Ej: 5-7 días hábiles" class="w-full rounded-lg border-gray-200 text-sm h-10 border px-3 focus:ring-amber-500" required />
                </div>
                <div class="md:col-span-1 flex items-end justify-center pb-1">
                    <button type="button" class="remove-time-rule-btn p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>`;
            timeRulesContainer.appendChild(div);
        });

        timeRulesContainer?.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-time-rule-btn');
            if (btn) {
                btn.closest('.time-rule-item').remove();
                if (document.querySelectorAll('.time-rule-item').length === 0) {
                    timeRulesContainer.innerHTML = `<div id="no-time-rules-msg" class="text-center py-8 border-2 border-dashed border-gray-100 rounded-2xl"><p class="text-sm text-gray-400">No hay rangos definidos. Se usará el tiempo de producción de fallback.</p></div>`;
                }
            }
        });
    });

    function attachVariantImagePreview(input) {
        if (!input) return;
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                const container = input.closest('.flex');
                const preview = container.querySelector('.variant-img-preview, img');
                if (preview && preview.tagName === 'IMG') {
                    preview.src = reader.result;
                } else if (preview) {
                    const img = document.createElement('img');
                    img.src = reader.result;
                    img.className = 'w-10 h-10 object-cover rounded-lg border border-gray-200';
                    preview.replaceWith(img);
                }
                // Update label text
                const label = container.querySelector('span');
                if (label) label.textContent = 'Cambiar';
            };
            reader.readAsDataURL(file);
        });
    }

    function removeNewImage(id) {
         const el = document.getElementById(id);
         if (el) el.remove();
    }

    function removeExistingImage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function getDragAfterElement(container, y, x) {
        const draggableElements = [...container.querySelectorAll('.existing-image-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
             if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateCoverBadge() {
        const items = document.querySelectorAll('.existing-image-item');
        items.forEach((item, index) => {
            const badge = item.querySelector('.cover-badge');
            if (badge) badge.style.opacity = index === 0 ? '1' : '0';
            item.classList.toggle('ring-2', index === 0);
            item.classList.toggle('ring-indigo-600', index === 0);
        });
    }

    async function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Collect variants
        const variants = [];
        document.querySelectorAll('.variant-item').forEach((item, index) => {
            const id = item.querySelector(`input[name^="variant_id_"]`)?.value;
            const name = item.querySelector(`input[name^="variant_name_"]`)?.value;
            const sku = item.querySelector(`input[name^="variant_sku_"]`)?.value;
            const price = item.querySelector(`input[name^="variant_price_"]`)?.value;
            const stock = item.querySelector(`input[name^="variant_stock_"]`)?.value;
            const existingImage = item.querySelector(`input[name^="variant_existing_image_"]`)?.value;
            const imageInput = item.querySelector(`input[name^="variant_image_"]`);
            const hasNewImage = imageInput && imageInput.files && imageInput.files.length > 0;
            
            if (name) {
                variants.push({ 
                    id: id || null, 
                    name, 
                    sku: sku || null, 
                    price: price ? parseFloat(price) : null, 
                    stock: parseInt(stock) || 0,
                    existingImage: existingImage || null,
                    hasNewImage: hasNewImage,
                    imageFieldName: hasNewImage ? `variant_image_file_${index}` : null 
                });
                // Add the image file to formData with a predictable name
                if (hasNewImage) {
                    formData.append(`variant_image_file_${index}`, imageInput.files[0]);
                }
            }
        });
        formData.append('variants_json', JSON.stringify(variants));
        
        const isActiveEl = document.getElementById('isActive');
        const isFeaturedEl = document.getElementById('isFeatured');
        if (isActiveEl) formData.set('isActive', isActiveEl.checked ? 'true' : 'false');
        if (isFeaturedEl) formData.set('isFeatured', isFeaturedEl.checked ? 'true' : 'false');

        const method = isNew ? 'POST' : 'PUT';
        const url = isNew ? '/api/products' : `/api/products/${id}`;

        try {
            const response = await fetch(url, { method: method, body: formData });
            if (response.ok) {
                const data = await response.json();
                const productId = isNew ? data.id : id;

                // Save production time rules as a separate call
                const timeRules = [];
                document.querySelectorAll('.time-rule-item').forEach((item) => {
                    const minQ = item.querySelector(`input[name^="time_rule_min_"]`)?.value;
                    const maxQ = item.querySelector(`input[name^="time_rule_max_"]`)?.value;
                    const time = item.querySelector(`input[name^="time_rule_time_"]`)?.value;
                    if (minQ && time) {
                        timeRules.push({
                            minQuantity: parseInt(minQ),
                            maxQuantity: maxQ ? parseInt(maxQ) : null,
                            productionTime: time,
                        });
                    }
                });

                const timeResp = await fetch(`/api/products/${productId}/production-time-rules`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rules: timeRules }),
                });

                if (!timeResp.ok) {
                    const errData = await timeResp.json().catch(() => ({}));
                    if(window.showToast) window.showToast('Producto guardado, pero error en reglas de tiempo: ' + (errData.error || 'Error desconocido'), 'error');
                    else alert('Producto guardado, pero error en reglas de tiempo: ' + (errData.error || 'Error desconocido'));
                } else {
                    if(window.showToast) window.showToast('Producto guardado correctamente', 'success');
                    else alert('Producto guardado correctamente');
                }

                setTimeout(() => {
                    if (isNew && data.id) window.location.href = `/admin/products/${data.id}`;
                    else window.location.reload();
                }, 1000);
            } else {
                const text = await response.text();
                alert('Error al guardar: ' + text);
            }
        } catch (error) {
            alert('Error de red al guardar el producto');
        }
    }
</script>

