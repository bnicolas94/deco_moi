---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { db } from '@/lib/db/connection';
import { categories, products } from '@/lib/db/schema';
import { asc, sql } from 'drizzle-orm';
import { Plus, Edit, Trash2, Eye, EyeOff, GripVertical, FolderTree, ChevronRight } from 'lucide-react';

// Fetch all categories with product count
const allCategories = await db
    .select({
        id: categories.id,
        name: categories.name,
        slug: categories.slug,
        image: categories.image,
        parentId: categories.parentId,
        order: categories.order,
        isActive: categories.isActive,
        productCount: sql<number>`(SELECT COUNT(*) FROM products WHERE products.category_id = ${categories.id})::int`,
    })
    .from(categories)
    .orderBy(asc(categories.order), asc(categories.name));

// Build tree structure
function buildTree(cats: typeof allCategories, parentId: number | null = null, depth: number = 0): any[] {
    return cats
        .filter(c => c.parentId === parentId)
        .map(c => ({
            ...c,
            depth,
            children: buildTree(cats, c.id, depth + 1),
        }));
}

const categoryTree = buildTree(allCategories);

function flattenTree(tree: any[]): any[] {
    return tree.reduce((acc, node) => {
        acc.push(node);
        acc.push(...flattenTree(node.children));
        return acc;
    }, []);
}

const flatCategories = flattenTree(categoryTree);
---

<AdminLayout title="Categorías">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Categorías</h1>
            <p class="text-gray-500 mt-1">Gestiona las categorías del catálogo.</p>
        </div>
        <a href="/admin/categories/new" class="inline-flex items-center px-4 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-sm">
            <Plus className="w-4 h-4 mr-2" />
            Nueva Categoría
        </a>
    </div>

    {flatCategories.length === 0 ? (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
            <FolderTree className="w-12 h-12 text-gray-300 mx-auto mb-4" />
            <h3 class="text-lg font-bold text-gray-900 mb-2">No hay categorías</h3>
            <p class="text-gray-500 mb-6">Crea tu primera categoría para organizar los productos.</p>
            <a href="/admin/categories/new" class="inline-flex items-center px-4 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700">
                <Plus className="w-4 h-4 mr-2" />
                Nueva Categoría
            </a>
        </div>
    ) : (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50/80 border-b border-gray-100">
                        <tr>
                            <th class="text-left px-6 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider w-8"></th>
                            <th class="text-left px-4 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Categoría</th>
                            <th class="text-left px-4 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Slug</th>
                            <th class="text-center px-4 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Productos</th>
                            <th class="text-center px-4 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Estado</th>
                            <th class="text-right px-6 py-3.5 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="categories-tbody" class="divide-y divide-gray-50">
                        {flatCategories.map((cat) => (
                            <tr class="category-row hover:bg-gray-50/50 transition-colors" data-id={cat.id} data-parent-id={cat.parentId} data-order={cat.order} draggable="true">
                                <td class="px-6 py-3 cursor-grab active:cursor-grabbing">
                                    <GripVertical className="w-4 h-4 text-gray-300" />
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-3" style={`padding-left: ${cat.depth * 24}px`}>
                                        {cat.depth > 0 && (
                                            <ChevronRight className="w-3.5 h-3.5 text-gray-300 -ml-1" />
                                        )}
                                        {cat.image && (
                                            <img src={cat.image} class="w-8 h-8 rounded-lg object-cover border border-gray-100" alt={cat.name} />
                                        )}
                                        <span class:list={["font-semibold text-gray-900", cat.depth > 0 && "text-gray-600 font-medium"]}>{cat.name}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-gray-500 text-xs font-mono">{cat.slug}</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-flex items-center justify-center min-w-[28px] px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600">
                                        {cat.productCount}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button 
                                        type="button"
                                        class="toggle-active-btn"
                                        data-category-id={cat.id}
                                        data-is-active={cat.isActive ? 'true' : 'false'}
                                        title={cat.isActive ? 'Click para desactivar' : 'Click para activar'}
                                    >
                                        {cat.isActive ? (
                                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-100">
                                                <Eye className="w-3 h-3" />
                                                Activa
                                            </span>
                                        ) : (
                                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-bold bg-gray-50 text-gray-400 border border-gray-100">
                                                <EyeOff className="w-3 h-3" />
                                                Inactiva
                                            </span>
                                        )}
                                    </button>
                                </td>
                                <td class="px-6 py-3 text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        <a href={`/admin/categories/${cat.id}`} class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Editar">
                                            <Edit className="w-4 h-4" />
                                        </a>
                                        <button 
                                            type="button" 
                                            class="delete-category-btn p-2 text-gray-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors" 
                                            data-category-id={cat.id} 
                                            data-category-name={cat.name}
                                            title="Eliminar"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    )}
</AdminLayout>

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
    // Toggle active/inactive
    document.querySelectorAll('.toggle-active-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const catId = btn.getAttribute('data-category-id');
            const currentActive = btn.getAttribute('data-is-active') === 'true';
            const newActive = !currentActive;

            // Warning for parent categories
            if (currentActive) {
                const row = btn.closest('tr');
                const hasChildren = document.querySelector(`tr[data-parent-id="${catId}"]`);
                if (hasChildren) {
                    const confirmed = confirm('Esta categoría tiene subcategorías. Al desactivarla, no serán visibles en la tienda. ¿Continuar?');
                    if (!confirmed) return;
                }
            }

            try {
                const resp = await fetch(`/api/categories/${catId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isActive: newActive }),
                });

                if (resp.ok) {
                    window.location.reload();
                } else {
                    const data = await resp.json().catch(() => ({}));
                    alert('Error: ' + (data.error || 'Error al cambiar estado'));
                }
            } catch (e) {
                alert('Error de red');
            }
        });
    });

    // Delete category
    document.querySelectorAll('.delete-category-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const catId = btn.getAttribute('data-category-id');
            const catName = btn.getAttribute('data-category-name');

            if (!confirm(`¿Eliminar la categoría "${catName}"? Esta acción no se puede deshacer.`)) return;

            try {
                const resp = await fetch(`/api/categories/${catId}`, { method: 'DELETE' });

                if (resp.ok) {
                    window.location.reload();
                } else {
                    const data = await resp.json().catch(() => ({}));
                    alert('Error: ' + (data.error || 'Error al eliminar'));
                }
            } catch (e) {
                alert('Error de red');
            }
        });
    });

    // Drag and Drop reordering
    const tbody = document.getElementById('categories-tbody');
    if (!tbody) return;

    let draggedRow = null;

    tbody.addEventListener('dragstart', (e) => {
        draggedRow = e.target.closest('tr');
        if (draggedRow) {
            draggedRow.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    tbody.addEventListener('dragend', () => {
        if (draggedRow) draggedRow.style.opacity = '1';
        draggedRow = null;
    });

    tbody.addEventListener('dragover', (e) => {
        e.preventDefault();
        const targetRow = e.target.closest('tr');
        if (targetRow && targetRow !== draggedRow) {
            const rect = targetRow.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (e.clientY < midY) {
                targetRow.parentNode.insertBefore(draggedRow, targetRow);
            } else {
                targetRow.parentNode.insertBefore(draggedRow, targetRow.nextSibling);
            }
        }
    });

    tbody.addEventListener('drop', async (e) => {
        e.preventDefault();
        // Collect new order
        const rows = tbody.querySelectorAll('tr');
        const items = [];
        rows.forEach((row, index) => {
            items.push({
                id: parseInt(row.getAttribute('data-id')),
                order: index + 1,
            });
        });

        try {
            const resp = await fetch('/api/categories/reorder', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items }),
            });

            if (!resp.ok) {
                alert('Error al guardar el orden');
            }
        } catch (e) {
            alert('Error de red al reordenar');
        }
    });
});
</script>
